<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="/public/css/style.css">
    <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/public/@fortawesome/fontawesome-free/css/all.css">
    <title>Type Racer</title>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <div class="header-logo inline-block">
                <img src="/public/img/logo.png" alt="მწერალი">
            </div>
            <ul class="navigation inline-block">
                <li class="nav-item inline-block"><a href="/race" class="active">რბოლა</a>
                <!-- </li><li class="nav-item inline-block"><a href="/pitstop">შესვენება</a> -->
                <!-- </li><li class="nav-item inline-block"><a href="/profile">პროფილი</a> -->
                <!-- </li><li class="nav-item inline-block"><a href="/history">ისტორია</a> -->
                <!-- </li><li class="nav-item inline-block"><a href="/competitions">შეჯიბრები</a> -->
                </li><li class="nav-item inline-block"><a href="/texts">ტექსტები</a>
                </li><li class="nav-item inline-block"><a href="/about">ჩვენს შესახებ</a>
                <!-- </li><li class="nav-item inline-block"><a href="/messages">მესიჯები</a> -->
                <!-- </li><li class="nav-item inline-block"><a href="/friends">მეგობრები</a> -->
                <!-- </li><li class="nav-item inline-block"><a href="/upgrade">გაუმჯობესება</a> -->
                </li>
            </ul>
        </div>
        <div class="header-right">
            <div class="user-avatar"></div>
            <div class="header-right-wrapper">
                <div class="right-top user-section">
                    <div class="header-username inline-block">
                        <span>სტუმარი</span>
                    </div>
                    <div class="header-user-control inline-block">
                        <a class="sign-link" href="#">შესვლა</a>
                        <span class="edit-info"></span>
                    </div>
                </div>
                <div class="right-bottom user-section">
                    <a href="#">ოსტატი</a> - 69 <a href="#">ს/წ</a>
                </div>
            </div>
            <div class="user-mini-info">
                <ul>
                    <li class="user-mini-info-item"><div class="user-mini-info-text">რანკი<span class="value">14</span></div></li>
                    <li class="user-mini-info-item"><div class="user-mini-info-text">წერის დონე<span class="value">14</span></div></li>
                    <li class="user-mini-info-item"><div class="user-mini-info-text">მოგებული რეისები<span class="value">14</span></div></li>
                    <li class="user-mini-info-item"><div class="user-mini-info-text">რეისების რაოდენობა<span class="value">14</span></div></li>
                    <li class="user-mini-info-item"><div class="user-mini-info-text">საუკეთესი რეისი<span class="value">14</span></div></li>
                    <li class="user-mini-info-item"><div class="user-mini-info-text">ბოლო რეისი<span class="value">14</span></div></li>
                    <li class="user-mini-info-item"><div class="user-mini-info-text">ყველა რეისის საშუალო<span class="value">14</span></div></li>
                    <li class="user-mini-info-item"><div class="user-mini-info-text">10 რეისის საშუალო<span class="value">14</span></div></li>
                    <li class="user-mini-info-item"><div class="user-mini-info-text">ბიო</div></li>
                </ul>
            </div>
        </div>
    </header>
    <main class="main">
        <div class="race-section">
            <h1 class="race-state">რბოლა მალე დაიწყება!</h1>
            <!-- <h1 class="race-state">dაელოდეთ ოპონენტებს...</h1> -->
            <!-- <h1 class="race-state">თქვენ გახვედით მე-4 ადგილზე.</h1> -->
            <!-- <h1 class="race-state">რბოლა დასრულდა.</h1> -->
            <ul class="race-tracks">
                <li class="race-track">
                    <div class="race-track-left">
                        <div class="race-track-user">
                            <div class="race-track-user-name">სტუმარი</div>
                            <span class="race-track-user-heli fas fa-helicopter"></span>
                        </div>
                        <div class="race-track-path"></div>
                    </div>
                    <div class="race-track-right">
                        <div class="race-track-place"></div>
                        <div class="race-track-speed">66 ს/წმ</div>
                    </div>
                </li>
                <li class="race-track me">
                    <div class="race-track-left">
                        <div class="race-track-user">
                            <div class="race-track-user-name">სტუმარი</div>
                            <span class="race-track-user-heli fas fa-helicopter"></span>
                        </div>
                        <div class="race-track-path"></div>
                    </div>
                    <div class="race-track-right">
                        <div class="race-track-place"></div>
                        <div class="race-track-speed">66 ს/წმ</div>
                    </div>
                </li>
                <li class="race-track">
                    <div class="race-track-left">
                        <div class="race-track-user">
                            <div class="race-track-user-name">სტუმარი</div>
                            <span class="race-track-user-heli fas fa-helicopter"></span>
                        </div>
                        <div class="race-track-path"></div>
                    </div>
                    <div class="race-track-right">
                        <div class="race-track-place"></div>
                        <div class="race-track-speed">66 ს/წმ</div>
                    </div>
                </li>
                <li class="race-track">
                    <div class="race-track-left">
                        <div class="race-track-user">
                            <div class="race-track-user-name">სტუმარი</div>
                            <span class="race-track-user-heli fas fa-helicopter"></span>
                        </div>
                        <div class="race-track-path"></div>
                    </div>
                    <div class="race-track-right">
                        <div class="race-track-place"></div>
                        <div class="race-track-speed">66 ს/წმ</div>
                    </div>
                </li>
            </ul>
            <div class="race-text"></div>
            <input type="text" class="race-input">
            <script>

                var text = `დაჯდა წერად ანდერძისა, საბრალოსა საუბრისად: "ჰე მეფეო, გავიპარე ძებნად ჩემგან საძებრისად! ვერ დავდგები შეუყრელად ჩემთა ცეცხლთა მომდებრისად; შემინდევ და წამატანე მოწყალება ღმრთეებრისად.`;

                var gameState = () => {return {
                    text, 
                    position: 0,
                    currentWord: true,
                    correct: true,
                    lastInput: '',
                    green: {a:0, b:0},
                    greenLine: {a:0, b:0},
                    redLine: {a:0, b:0},
                    line: {a:0, b:text.indexOf(' ', 0)},
                    red: {a:0, b:0},
                    rest: {a:text.indexOf(' ', 0), b:text.length},
                    step (c) {
                        var gameState = gameStateCopy(this);
                        var correctNewChar = gameState.correct && gameState.text[gameState.position] == c;
                        var correctNewWord = c == ' ' && correctNewChar;

                        // Green
                        if(correctNewWord){
                            gameState.green.b = gameState.position + 1;
                        }

                        // Green line
                        if(correctNewWord){
                            gameState.greenLine.a = gameState.position + 1;
                            gameState.greenLine.b = gameState.position + 1;
                        }else if(correctNewChar){
                            gameState.greenLine.b = gameState.position + 1;
                        }

                        // Red Line
                        if(!correctNewChar && gameState.text[gameState.position] != ' ' && gameState.currentWord) {
                            if(!gameState.correct){
                                gameState.redLine.b++;
                            }else{
                                gameState.redLine.a = gameState.position;
                                gameState.redLine.b = gameState.position + 1;
                            }
                        }

                        // Line
                        if(gameState.currentWord){
                            if(gameState.text[gameState.position] != ' '){
                                gameState.line.a++;
                            }else if(correctNewChar){
                                gameState.line.a = gameState.position + 1;
                                gameState.line.b = gameState.text.indexOf(' ', gameState.line.a);
                                if(gameState.line.b == -1){
                                    gameState.line.b = gameState.text.length;
                                }
                            }
                        }

                        // Red
                        if (!correctNewChar) {
                            if (gameState.text[gameState.position] == ' ' && gameState.currentWord){
                                gameState.red.a = gameState.position;
                                gameState.red.b = gameState.position + 1;
                            }
                            if(!gameState.currentWord)
                                gameState.red.b = gameState.position + 1;
                        }
                        
                        // Rest
                        gameState.rest.a = gameState.text.indexOf(' ', gameState.position + 1);
                        if(gameState.rest.a == -1){
                            gameState.rest.a = gameState.text.length;
                        }
                        if(!correctNewChar && (gameState.text[gameState.position] == ' ' || !gameState.currentWord))
                            gameState.rest.a = gameState.position + 1;

                        gameState.currentWord = !(!gameState.currentWord || !correctNewChar && gameState.text[gameState.position] == ' ');
                        gameState.correct = correctNewChar;
                        gameState.position++;
                        console.log(gameState);
                        return gameState;
                    },
                    getPart (place) {
                        return this.text.substring(this[place].a, this[place].b);
                    },
                    raceText () {
                        return `
                            <span class="race-text-correct">${this.getPart('green')}</span><!--
                         --><span class="race-text-correct race-text-current">${this.getPart('greenLine')}</span><!--
                         --><span class="race-text-incorrect race-text-current">${this.getPart('redLine')}</span><!--
                         --><span class="race-text-incorrect">${this.getPart('red')}</span><!--
                         --><span class="race-text-cursor"></span><!--
                         --><span class="race-text-current">${this.getPart('line')}</span><!--
                         --><span class="race-text-rest">${this.getPart('rest')}</span>
                        `;
                    }
                }}
                var gameStateCopy = (stateToCopy) => {return {
                    text: stateToCopy.text,
                    position: stateToCopy.position,
                    currentWord: stateToCopy.currentWord,
                    correct: stateToCopy.correct,
                    lastInput: stateToCopy.lastInput,
                    green: {a:stateToCopy.green.a, b:stateToCopy.green.b},
                    greenLine: {a:stateToCopy.greenLine.a, b:stateToCopy.greenLine.b},
                    redLine: {a:stateToCopy.redLine.a, b:stateToCopy.redLine.b},
                    line: {a:stateToCopy.line.a, b:stateToCopy.line.b},
                    red: {a:stateToCopy.red.a, b:stateToCopy.red.b},
                    rest: {a:stateToCopy.rest.a, b:stateToCopy.rest.b},
                    step: stateToCopy.step,
                    getPart: stateToCopy.getPart,
                    raceText: stateToCopy.raceText
                }}

                var states = [gameState()];

                var raceInput = document.querySelector('.race-input');

                raceInput.oninput = (event) => {
                    var key = event.keyCode || event.charCode;

                    if(raceInput.value.length < states[states.length - 1].lastInput.length){
                        var n = states[states.length - 1].lastInput.length - raceInput.value.length;
                        for(var i = 0; i < n; i++)
                            states.splice(states.length - 1, 1);
                    }else if(states[states.length - 1].text.length != states[states.length - 1].position){
                        var c = raceInput.value[raceInput.value.length - 1];
                        var newState = states[states.length - 1].step(c);
                        if(newState.correct && c == ' '){
                            raceInput.value = '';
                        }
                        newState.lastInput = raceInput.value;
                        states.push(newState);
                    }else{
                        raceInput.value = states[states.length - 1].lastInput;
                    }
                    document.querySelector('.race-text').innerHTML = states[states.length - 1].raceText();
                }
                document.querySelector('.race-text').innerHTML = states[states.length - 1].raceText();
            </script>
        </div>
        <div class="high-scores-section">

        </div>
    </main>
</body>
</html>